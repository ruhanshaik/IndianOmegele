<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Indian Omegle</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        /* Chat bubble styles from sample */
        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message-sent {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background: #F2F2F7;
            color: black;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        
        .mic-recording {
            color: #FF3B30;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        audio {
            max-width: 100%;
            height: 35px;
            margin-top: 5px;
        }
    </style>
</head>
<body class="chat-body">
    <!-- Chat Header -->
    <header class="chat-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="index.html" class="btn btn-sm btn-outline-light me-3" onclick="endChat()">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div>
                        <h5 class="mb-0" id="partnerName">Connecting...</h5>
                        <small class="text-light">
                            <span id="partnerInfo">Searching for partner</span>
                            <span class="ms-2 online-indicator" id="onlineIndicator"></span>
                        </small>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="online-indicator me-2"></div>
                    <span id="onlineCount" class="text-white fw-bold">0</span>
                    <button class="btn btn-sm btn-outline-light ms-3" id="endChatBtn" title="End Chat">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Messages Container -->
    <main class="chat-container" id="chatContainer">
        <div class="container">
            <!-- Welcome Message -->
            <div class="welcome-message text-center py-5" id="welcomeMessage">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4>Looking for a chat partner...</h4>
                <p class="text-muted">You'll be connected with a random user shortly</p>
            </div>
            
            <!-- Messages will be appended here -->
            <div id="messagesContainer" class="messages-container" style="display: none;"></div>
        </div>
    </main>

    <!-- Chat Input Area -->
    <footer class="chat-input-area" id="chatInputArea" style="display: none;">
        <div class="container">
            <!-- Reactions Bar -->
            <div class="reactions-bar mb-2" id="reactionsBar">
                <button class="btn btn-sm btn-outline-secondary reaction-btn" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
                <button class="btn btn-sm btn-outline-secondary reaction-btn" data-reaction="üëç">üëç</button>
                <button class="btn btn-sm btn-outline-secondary reaction-btn" data-reaction="üòÇ">üòÇ</button>
                <button class="btn btn-sm btn-outline-secondary reaction-btn" data-reaction="üòÆ">üòÆ</button>
                <button class="btn btn-sm btn-outline-secondary reaction-btn" data-reaction="üò¢">üò¢</button>
                <button class="btn btn-sm btn-outline-secondary reaction-btn" data-reaction="üî•">üî•</button>
            </div>
            
            <!-- Input Form -->
            <div class="input-group">
                <button class="btn btn-outline-secondary" type="button" id="voiceRecordBtn" title="Hold to record">
                    <i class="fas fa-microphone"></i>
                </button>
                <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." autocomplete="off">
                <button class="btn btn-primary" type="button" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <div class="mt-2 text-center">
                <small class="text-muted">
                    <i class="fas fa-exclamation-triangle"></i>
                    Keep it friendly and respectful. Inappropriate chats will be warned.
                </small>
            </div>
        </div>
    </footer>

    <!-- Warning Modal -->
    <div class="modal fade" id="warningModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Partner Disconnected
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="alert alert-warning">
                        <h4 class="alert-heading">Your partner has left the chat</h4>
                        <p>Finding a new partner...</p>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="findNewPartner()">
                        Find New Partner
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Socket connection
        const socket = io();
        let mediaRecorder;
        let audioChunks = [];
        let userData = JSON.parse(sessionStorage.getItem('userData'));
        let partnerData = JSON.parse(sessionStorage.getItem('partnerData'));
        
        // Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const chatInputArea = document.getElementById('chatInputArea');
        const voiceRecordBtn = document.getElementById('voiceRecordBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const partnerName = document.getElementById('partnerName');
        const partnerInfo = document.getElementById('partnerInfo');
        const endChatBtn = document.getElementById('endChatBtn');
        const warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            
            // Live user count
            socket.on('user-count', (count) => {
                document.getElementById('onlineCount').textContent = count;
            });
            
            // Receive messages
            socket.on('receive-message', (content) => {
                appendMessage('them', content);
            });
            
            // Partner disconnected
            socket.on('partner-disconnected', () => {
                warningModal.show();
            });
            
            // If we have partner data, setup chat
            if (partnerData) {
                setupChat(partnerData);
            }
            
            // Voice recording setup
            setupVoiceRecording();
            
            // Event listeners
            sendBtn.addEventListener('click', sendTextMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendTextMessage();
            });
            
            endChatBtn.addEventListener('click', function() {
                if (confirm('End this chat?')) {
                    socket.emit('end-chat');
                    window.location.href = 'index.html';
                }
            });
            
            // Reactions
            document.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const reaction = this.getAttribute('data-reaction');
                    socket.emit('send-message', { type: 'text', data: reaction });
                    appendMessage('me', { type: 'text', data: reaction });
                });
            });
            
            // Connect to server
            if (partnerData) {
                socket.emit('find-match', userData);
            }
        });
        
        function setupChat(partner) {
            partnerName.textContent = partner.name;
            partnerInfo.textContent = `${partner.age} ‚Ä¢ ${partner.gender} ‚Ä¢ ${partner.city}`;
            
            welcomeMessage.style.display = 'none';
            messagesContainer.style.display = 'block';
            chatInputArea.style.display = 'block';
            
            appendSystemMessage(`Connected with ${partner.name}! Say hello üëã`);
        }
        
        function setupVoiceRecording() {
            voiceRecordBtn.addEventListener('click', async function() {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    voiceRecordBtn.classList.remove('mic-recording');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64Audio = reader.result;
                            const messageObj = { type: 'voice', data: base64Audio };
                            socket.emit('send-message', messageObj);
                            appendMessage('me', messageObj);
                        };
                        voiceRecordBtn.classList.remove('mic-recording');
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    voiceRecordBtn.classList.add('mic-recording');

                    // Auto stop after 10 seconds
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            mediaRecorder.stop();
                        }
                    }, 10000);

                } catch (err) {
                    alert("Microphone permission required for voice messages.");
                }
            });
        }
        
        function sendTextMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            const messageObj = { type: 'text', data: text };
            socket.emit('send-message', messageObj);
            appendMessage('me', messageObj);
            messageInput.value = '';
            messageInput.focus();
        }
        
        function appendMessage(side, content) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let messageContent = '';
            
            if (content.type === 'voice') {
                messageContent = `<audio controls src="${content.data}"></audio>`;
            } else {
                messageContent = content.data;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${side === 'me' ? 'text-end' : 'text-start'}`;
            messageDiv.innerHTML = `
                <div class="message-bubble ${side === 'me' ? 'message-sent' : 'message-received'}">
                    ${messageContent}
                    <div class="message-timestamp mt-1" style="font-size: 0.7rem; opacity: 0.7;">${time}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function appendSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'text-center my-3';
            messageDiv.innerHTML = `<span class="badge bg-secondary">${text}</span>`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function findNewPartner() {
            warningModal.hide();
            sessionStorage.removeItem('partnerData');
            
            welcomeMessage.style.display = 'block';
            messagesContainer.style.display = 'none';
            chatInputArea.style.display = 'none';
            partnerName.textContent = 'Searching...';
            partnerInfo.textContent = 'Looking for new partner';
            
            socket.emit('find-match', userData);
            appendSystemMessage('Searching for a new chat partner...');
        }
        
        function endChat() {
            socket.emit('end-chat');
            sessionStorage.removeItem('partnerData');
            sessionStorage.removeItem('userData');
        }
        
        // Clean up on page leave
        window.addEventListener('beforeunload', endChat);
    </script>
</body>
</html>